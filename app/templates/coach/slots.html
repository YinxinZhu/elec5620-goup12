{% extends 'base.html' %}
{% block title %}{{ _('Availability') }}{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
{% endblock %}

{% block content %}
<h1 class="h3 mb-4">{{ _('Availability management') }}</h1>
<div class="card mb-4">
  <div class="card-body">
    <h2 class="h5">{{ _('Add a new slot') }}</h2>
    <form method="post" class="row g-3">
      <div class="col-md-4">
        <label class="form-label" for="start_time">{{ _('Start time') }}</label>
        <input
          type="text"
          class="form-control"
          id="start_time"
          name="start_time"
          placeholder="{{ 'yyyy/mm/dd --:--' if active_language == 'ENGLISH' else _('yyyy/mm/dd --:--') }}"
          data-placeholder="{{ 'yyyy/mm/dd --:--' if active_language == 'ENGLISH' else _('yyyy/mm/dd --:--') }}"
          autocomplete="off"
          required
        >
      </div>
      <div class="col-md-3">
        <label class="form-label" for="duration">{{ _('Duration') }}</label>
        <select class="form-select" id="duration" name="duration">
          <option value="30">{{ _('30 minutes') }}</option>
          <option value="60">{{ _('60 minutes') }}</option>
        </select>
      </div>
      {% if current_user.is_admin %}
      <div class="col-md-5">
        <label class="form-label" for="coach_id">{{ _('Coach') }}</label>
        <select class="form-select" id="coach_id" name="coach_id" required>
          <option value="" disabled selected>{{ _('Select a coach') }}</option>
          {% for coach in coach_choices %}
          <option value="{{ coach.id }}">{{ coach.name }} ({{ coach.mobile_number }})</option>
          {% endfor %}
        </select>
      </div>
      {% else %}
      <div class="col-md-5">
        <label class="form-label" for="location">{{ _('Meeting location') }}</label>
        <input class="form-control" id="location" name="location" placeholder="{{ _('Sydney Olympic Park') }}" required>
      </div>
      {% endif %}
      {% if current_user.is_admin %}
      <div class="col-md-12">
        <label class="form-label" for="location">{{ _('Meeting location') }}</label>
        <input class="form-control" id="location" name="location" placeholder="{{ _('Sydney Olympic Park') }}" required>
      </div>
      {% endif %}
      <div class="col-12">
        <button class="btn btn-primary" type="submit">{{ _('Add slot') }}</button>
      </div>
    </form>
  </div>
</div>
<h2 class="h5">{{ _('All coach slots') if current_user.is_admin else _('Your slots') }}</h2>
{% if slots %}
<div class="table-responsive">
  <table class="table align-middle">
    <thead>
      <tr>
        <th scope="col">{{ _('Start') }}</th>
        <th scope="col">{{ _('Duration') }}</th>
        <th scope="col">{{ _('Location') }}</th>
        <th scope="col">{{ _('Status') }}</th>
        {% if current_user.is_admin %}
        <th scope="col">{{ _('Coach') }}</th>
        {% endif %}
        <th scope="col"></th>
      </tr>
    </thead>
    <tbody>
      {% for slot in slots %}
      <tr>
        <td>{{ slot.start_time.strftime('%d %b %Y %H:%M') }}</td>
        <td>{{ slot.duration_minutes }} {{ _('minutes') }}</td>
        <td>{{ slot.location_text }}</td>
        <td>
          <span class="badge bg-{{ 'success' if slot.status == 'available' else 'warning' if slot.status == 'booked' else 'secondary' }}">{{ _(slot.status.replace('_', ' ').title()) }}</span>
        </td>
        {% if current_user.is_admin %}
        <td>{{ slot.coach.name }}</td>
        {% endif %}
        <td class="text-end">
          <form method="post" action="{{ url_for('coach.delete_slot', slot_id=slot.id) }}" onsubmit="return confirm('{{ _('Delete this slot?') }}');">
            <button type="submit" class="btn btn-sm btn-outline-danger" {% if slot.appointment and slot.appointment.status == 'booked' %}disabled{% endif %}>{{ _('Delete') }}</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="alert alert-info">{{ _('No availability yet. Add your first slot above.') }}</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
{% if active_language == 'CHINESE' %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/zh.js"></script>
{% endif %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (typeof flatpickr !== 'function') {
      return;
    }
    var input = document.getElementById('start_time');
    if (!input) {
      return;
    }
    var placeholder = input.dataset.placeholder || input.getAttribute('placeholder') || '';
    var options = {
      enableTime: true,
      time_24hr: true,
      dateFormat: 'Y/m/d H:i',
      altInput: true,
      altFormat: '{{ "Y/m/d H:i" if active_language == "ENGLISH" else "Y年/m月/d日 H:i" }}',
      minuteIncrement: 5,
      allowInput: true,
      disableMobile: true
    };
    var locale = '{{ "zh" if active_language == "CHINESE" else "en" }}';
    if (locale === 'en') {
      options.locale = locale;
    } else if (flatpickr.l10ns && flatpickr.l10ns[locale]) {
      options.locale = flatpickr.l10ns[locale];
    }
    options.onReady = options.onValueUpdate = function (selectedDates, dateStr, instance) {
      if (instance.altInput && placeholder) {
        instance.altInput.placeholder = placeholder;
      }
    };
    flatpickr(input, options);
  });
</script>
{% endblock %}
