{% extends "base.html" %}
{% block title %}{{ _('Wrong answer notebook') }} · {{ super() }}{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
    <div>
        <h1 class="h3 mb-1">{{ _('Wrong answer notebook') }}</h1>
        <p class="text-muted mb-0">{{ _('Revisit the questions you missed and plan targeted revisions.') }}</p>
    </div>
</div>

{% if available_states %}
<form method="get" class="row gy-2 gx-3 align-items-end mb-4">
    <div class="col-sm-4 col-lg-3">
        <label for="state" class="form-label">{{ _('State / Territory') }}</label>
        <select id="state" name="state" class="form-select" onchange="this.form.submit()">
            {% for state_code in available_states %}
            <option value="{{ state_code }}" {% if state_code == selected_state %}selected{% endif %}>{{ state_code }}</option>
            {% endfor %}
        </select>
    </div>
</form>
{% endif %}

{% if not selected_state %}
<div class="alert alert-info" role="alert">{{ _('Select a state to review your notebook.') }}</div>
{% else %}

<!-- Overview -->
<div class="card mb-4">
    <div class="card-body">
        <h2 class="h5 mb-3">{{ _('Overview') }}</h2>
        {% if entries %}
        <p class="text-muted mb-1">
            {{ _('You have logged %(count)s wrong attempts in this state.', count=total_wrong) }}
        </p>
        {% else %}
        <p class="text-muted mb-1">
            {{ _('No wrong answers recorded for this state yet.') }}
        </p>
        {% endif %}
        <p class="text-muted mb-0">{{ _('Starred questions saved') }}: {{ starred_entries|length }}</p>
    </div>
</div>

<div class="row g-4">

    <!-- Wrong answers -->
    <div class="col-12">
        <h2 class="h5 mb-3">{{ _('Wrong answers') }}</h2>

        {% if entries %}
        <div class="accordion" id="wrongNotebook">
            {% for entry in entries %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="wrongHeading{{ loop.index }}">
                    <button
                            class="accordion-button {% if not loop.first %}collapsed{% endif %}"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#wrongCollapse{{ loop.index }}"
                            aria-expanded="{{ 'true' if loop.first else 'false' }}"
                            aria-controls="wrongCollapse{{ loop.index }}"
                    >
                        {{ entry.question.qid }} · {{ entry.question.prompt|striptags|truncate(120) }}
                    </button>
                </h2>

                <div id="wrongCollapse{{ loop.index }}"
                     class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                     aria-labelledby="wrongHeading{{ loop.index }}"
                     data-bs-parent="#wrongNotebook">

                    <div class="accordion-body">
                        <p class="text-muted small mb-2">{{ _('Topic') }}: {{ entry.question.topic }}</p>
                        <p class="text-muted small mb-3">
                            {{ _('Wrong attempts') }}: {{ entry.wrong_count }} ·
                            {{ _('Last wrong at') }}:
                            {{ entry.last_wrong_at.strftime('%Y-%m-%d %H:%M') if entry.last_wrong_at else _('Never') }}
                        </p>

                        <ul class="list-unstyled mb-3 options-list">
                            <li {% if entry.question.correct_option == 'A' %}class="correct"{% endif %}><strong>A.</strong> {{ entry.question.option_a }}</li>
                            <li {% if entry.question.correct_option == 'B' %}class="correct"{% endif %}><strong>B.</strong> {{ entry.question.option_b }}</li>
                            <li {% if entry.question.correct_option == 'C' %}class="correct"{% endif %}><strong>C.</strong> {{ entry.question.option_c }}</li>
                            <li {% if entry.question.correct_option == 'D' %}class="correct"{% endif %}><strong>D.</strong> {{ entry.question.option_d }}</li>
                        </ul>

                        <div class="alert alert-info py-2 mb-3">
                            {{ _('Correct answer') }}: {{ entry.question.correct_option }}
                        </div>

                        {% if entry.question.explanation %}
                        <p class="text-muted small mb-3">
                            {{ _('Explanation') }}: {{ entry.question.explanation }}
                        </p>
                        {% endif %}

                        <div class="d-flex justify-content-end gap-4">
                            <!-- AI generate variant questions -->
                            <a class="btn btn-sm btn-outline-primary"
                               href="{{ url_for('student.variant', question=entry.question.id) }}">
                                {{ _('AI generate variant questions') }}
                            </a>

                            <!-- Remove (direct delete) -->
                            <form method="post"
                                  action="{{ url_for('student.remove_notebook_entry', question_id=entry.question.id) }}"
                                  onsubmit="return confirm('{{ _('Remove this item from the notebook?') }}');">
                                <input type="hidden" name="state" value="{{ entry.state }}">
                                <input type="hidden" name="next" value="{{ request.full_path or request.path }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    {{ _('Remove') }}
                                </button>
                            </form>
                        </div>
                    </div> <!-- /accordion-body -->
                </div>   <!-- /accordion-collapse -->
            </div>     <!-- /accordion-item -->
            {% endfor %}
        </div>       <!-- /accordion -->
        {% else %}
        <div class="alert alert-success mb-0">{{ _('No wrong answers recorded for this state yet.') }}</div>
        {% endif %}
    </div> <!-- /col-12 -->

    <!-- Starred questions -->
    <div class="col-12">
        <h2 class="h5 mb-3">{{ _('Starred questions') }}</h2>
        {% if starred_entries %}
        <div class="accordion" id="starredNotebook">
            {% for entry in starred_entries %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="starHeading{{ loop.index }}">
                    <button
                            class="accordion-button {% if not loop.first %}collapsed{% endif %}"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#starCollapse{{ loop.index }}"
                            aria-expanded="{{ 'true' if loop.first else 'false' }}"
                            aria-controls="starCollapse{{ loop.index }}"
                    >
                        {{ entry.question.qid }} · {{ entry.question.prompt|striptags|truncate(120) }}
                    </button>
                </h2>
                <div id="starCollapse{{ loop.index }}"
                     class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                     aria-labelledby="starHeading{{ loop.index }}"
                     data-bs-parent="#starredNotebook">
                    <div class="accordion-body">
                        <p class="text-muted small mb-2">{{ _('Topic') }}: {{ entry.question.topic }}</p>
                        <p class="text-muted small mb-3">{{ _('Starred at') }}: {{ entry.created_at.strftime('%Y-%m-%d %H:%M') }}</p>

                        <ul class="list-unstyled mb-3 options-list">
                            <li {% if entry.question.correct_option == 'A' %}class="correct"{% endif %}><strong>A.</strong> {{ entry.question.option_a }}</li>
                            <li {% if entry.question.correct_option == 'B' %}class="correct"{% endif %}><strong>B.</strong> {{ entry.question.option_b }}</li>
                            <li {% if entry.question.correct_option == 'C' %}class="correct"{% endif %}><strong>C.</strong> {{ entry.question.option_c }}</li>
                            <li {% if entry.question.correct_option == 'D' %}class="correct"{% endif %}><strong>D.</strong> {{ entry.question.option_d }}</li>
                        </ul>

                        <div class="alert alert-info py-2 mb-3">
                            {{ _('Correct answer') }}: {{ entry.question.correct_option }}
                        </div>

                        {% if entry.question.explanation %}
                        <p class="text-muted small mb-3">{{ _('Explanation') }}: {{ entry.question.explanation }}</p>
                        {% endif %}

                        <div class="d-flex justify-content-end gap-4 flex-wrap">
                            <!-- AI generate variant questions -->
                            <a
                                class="btn btn-sm btn-outline-primary"
                                href="{{ url_for('student.variant', question=entry.question.id) }}"
                            >
                                {{ _('AI generate variant questions') }}
                            </a>
                            <!-- Remove (direct delete) -->
                            <form method="post" action="{{ url_for('student.toggle_star', question_id=entry.question.id) }}">
                                <input type="hidden" name="action" value="unstar">
                                <input type="hidden" name="next" value="{{ request.full_path or request.path }}">
                                <button type="submit" class="btn btn-sm btn-warning">⭐ {{ _('Unstar') }}</button>
                            </form>
                        </div>
                    </div> <!-- /accordion-body -->
                </div>   <!-- /accordion-collapse -->
            </div>     <!-- /accordion-item -->
            {% endfor %}
        </div>       <!-- /accordion -->
        {% else %}
        <div class="alert alert-info mb-0">{{ _('No starred questions yet.') }}</div>
        {% endif %}
    </div> <!-- /col-12 -->

</div> <!-- /row -->

{% endif %}
{% endblock %}
