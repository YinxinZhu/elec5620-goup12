{% extends 'base.html' %}
{% block title %}{{ _('Student Dashboard') }}{% endblock %}
{% block content %}
<h1 class="h4 mb-4">{{ _('Learner Dashboard') }}</h1>
<p class="text-muted">{{ _('Welcome back, {name}. Track your bookings and latest practice progress below.').format(name=current_user.name) }}</p>

<section class="mb-5">
  <h2 class="h5">{{ _('Coach availability') }}</h2>
  {% if not assigned_coach %}
  <div class="alert alert-info" role="alert">
    {{ _('You are not assigned to a coach yet. Contact support to be paired before booking a session.') }}
  </div>
  {% else %}
  <p class="text-muted small">{{ _('Sessions with coach {name}.').format(name=assigned_coach.name) }}</p>
  {% if available_slots %}
  <div class="row g-3">
    {% for slot in available_slots %}
    <div class="col-md-6 col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h3 class="h6 mb-1">{{ slot.start_time.strftime('%d %b %Y %H:%M') }}</h3>
          <p class="text-muted small mb-3">{{ slot.duration_minutes }} {{ _('minutes') }} Â· {{ slot.location_text }}</p>
          <form method="post" action="{{ url_for('student.book_slot', slot_id=slot.id) }}" class="mt-auto">
            <button class="btn btn-primary btn-sm w-100" type="submit">{{ _('Book this session') }}</button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-secondary" role="alert">
    {{ _('Your coach has no open times right now. Check back later or message them directly.') }}
  </div>
  {% endif %}
  {% endif %}
</section>

<section class="mb-5">
  <h2 class="h5">{{ _('Upcoming sessions') }}</h2>
  {% if upcoming_appointments %}
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th scope="col">{{ _('Start') }}</th>
          <th scope="col">{{ _('Coach') }}</th>
          <th scope="col">{{ _('Location') }}</th>
          <th scope="col">{{ _('Status') }}</th>
          <th scope="col" class="text-end">{{ _('Actions') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in upcoming_appointments %}
        {% set appointment = entry.appointment %}
        {% set cancel_mode = entry.cancel_mode %}
        <tr>
          <td>{{ appointment.slot.start_time.strftime('%d %b %Y %H:%M') }}</td>
          <td>{{ appointment.slot.coach.name }}</td>
          <td>{{ appointment.slot.location_text }}</td>
          <td>{{ entry.status_label }}</td>
          <td class="text-end">
            {% if cancel_mode == 'self_service' %}
            <form method="post" action="{{ url_for('student.cancel_appointment', appointment_id=appointment.id) }}">
              <button class="btn btn-outline-danger btn-sm" type="submit">{{ _('Cancel session') }}</button>
            </form>
            {% elif cancel_mode == 'needs_approval' %}
            <form method="post" action="{{ url_for('student.cancel_appointment', appointment_id=appointment.id) }}">
              <button class="btn btn-outline-warning btn-sm" type="submit">{{ _('Request cancellation') }}</button>
              <div class="form-text">{{ _('Within 24 hours, your coach must approve the request.') }}</div>
            </form>
            {% elif cancel_mode == 'pending' %}
            <span class="badge bg-warning text-dark">{{ _('Awaiting coach approval') }}</span>
            {% else %}
            <span class="text-muted small">{{ _('Cancellations closed within 2 hours of start time.') }}</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info" role="alert">
    {{ _('You have no upcoming sessions booked. Check with your coach to schedule one.') }}
  </div>
  {% endif %}
</section>

<section>
  <h2 class="h5">{{ _('Recent practice summary') }}</h2>
  {% if latest_summary %}
  <p class="mb-1">{{ _('Last mock exam score:') }} <strong>{{ latest_summary.score }}%</strong></p>
  <p class="text-muted">{{ _('Attempted on {date}.').format(date=latest_summary.taken_at.strftime('%d %b %Y')) }}</p>
  {% else %}
  <div class="alert alert-secondary" role="alert">
    {{ _('Complete a mock exam in the learner app to see your progress here.') }}
  </div>
  {% endif %}
</section>
{% endblock %}
