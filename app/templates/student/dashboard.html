{% extends 'base.html' %}
{% block title %}{{ _('Student Dashboard') }}{% endblock %}
{% block content %}
<h1 class="h4 mb-4">{{ _('Learner Dashboard') }}</h1>
<p class="text-muted">{{ _('Welcome back, {name}. Track your bookings and latest practice progress below.').format(name=current_user.name) }}</p>

<section class="mb-5">
  <h2 class="h5">{{ _('Coach availability') }}</h2>
  {% if not assigned_coach %}
  <div class="alert alert-info" role="alert">
    {{ _('You are not assigned to a coach yet. Contact support to be paired before booking a session.') }}
  </div>
  {% else %}
  <p class="text-muted small">{{ _('Sessions with coach {name}.').format(name=assigned_coach.name) }}</p>
  {% if available_slots %}
  {% set next_slot = available_slots[0] %}
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <p class="text-muted small mb-2">{{ _('Next available session') }}</p>
      <h3 class="h6 mb-1">{{ next_slot.start_time.strftime('%d %b %Y %H:%M') }}</h3>
      <p class="text-muted small mb-0">{{ next_slot.duration_minutes }} {{ _('minutes') }} 路 {{ next_slot.location_text }}</p>
      <form method="post" action="{{ url_for('student.book_slot', slot_id=next_slot.id) }}" class="mt-3">
        <button class="btn btn-primary btn-sm" type="submit">{{ _('Book this session') }}</button>
      </form>
    </div>
  </div>
  {% if available_slots|length > 1 %}
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <h3 class="h6 mb-3">{{ _('Other available times') }}</h3>
      <ul class="list-unstyled mb-0">
        {% for slot in available_slots[1:] %}
        <li class="py-3 border-top">
          <div>
            <strong>{{ slot.start_time.strftime('%d %b %Y %H:%M') }}</strong>
            <div class="text-muted small">{{ slot.duration_minutes }} {{ _('minutes') }} 路 {{ slot.location_text }}</div>
          </div>
          <form method="post" action="{{ url_for('student.book_slot', slot_id=slot.id) }}" class="mt-2">
            <button class="btn btn-outline-primary btn-sm" type="submit">{{ _('Book') }}</button>
          </form>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}
  {% else %}
  <div class="alert alert-secondary" role="alert">
    {{ _('Your coach has no open times right now. Check back later or message them directly.') }}
  </div>
  {% endif %}
  {% endif %}
</section>

<section class="mb-5">
  <h2 class="h5">{{ _('Upcoming sessions') }}</h2>
  {% if upcoming_appointments %}
  {% set next_entry = upcoming_appointments[0] %}
  {% set next_appointment = next_entry.appointment %}
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
        <div>
          <h3 class="h6 text-success mb-1">{{ _('Next session') }}</h3>
          <p class="mb-1 fw-semibold">{{ next_appointment.slot.start_time.strftime('%d %b %Y %H:%M') }}</p>
          <p class="text-muted small mb-0">{{ next_appointment.slot.coach.name }} 路 {{ next_appointment.slot.location_text }}</p>
        </div>
        <div class="w-100 w-md-auto text-md-end">
          <p class="text-muted small mb-2">{{ next_entry.status_label }}</p>
          {% set cancel_mode = next_entry.cancel_mode %}
          {% if cancel_mode == 'self_service' %}
          <form method="post" action="{{ url_for('student.cancel_appointment', appointment_id=next_appointment.id) }}" class="d-flex gap-2">
            <button class="btn btn-outline-danger w-100 w-md-auto" type="submit">{{ _('Cancel session') }}</button>
          </form>
          {% elif cancel_mode == 'needs_approval' %}
          <form method="post" action="{{ url_for('student.cancel_appointment', appointment_id=next_appointment.id) }}">
            <button class="btn btn-outline-warning w-100 w-md-auto" type="submit">{{ _('Request cancellation') }}</button>
            <div class="form-text text-start text-md-end">{{ _('Within 24 hours, your coach must approve the request.') }}</div>
          </form>
          {% elif cancel_mode == 'pending' %}
          <span class="badge bg-warning text-dark">{{ _('Awaiting coach approval') }}</span>
          {% else %}
          <span class="text-muted small">{{ _('Cancellations closed within 2 hours of start time.') }}</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% if upcoming_appointments|length > 1 %}
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white">
      <h3 class="h6 mb-0">{{ _('Later sessions') }}</h3>
    </div>
    <ul class="list-group list-group-flush">
      {% for entry in upcoming_appointments[1:] %}
      {% set appointment = entry.appointment %}
      {% set cancel_mode = entry.cancel_mode %}
      <li class="list-group-item">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
          <div>
            <p class="mb-1 fw-semibold">{{ appointment.slot.start_time.strftime('%d %b %Y %H:%M') }}</p>
            <p class="text-muted small mb-0">{{ appointment.slot.coach.name }} 路 {{ appointment.slot.location_text }}</p>
          </div>
          <div class="w-100 w-lg-auto text-lg-end">
            <p class="text-muted small mb-2">{{ entry.status_label }}</p>
            {% if cancel_mode == 'self_service' %}
            <form method="post" action="{{ url_for('student.cancel_appointment', appointment_id=appointment.id) }}">
              <button class="btn btn-outline-danger w-100 w-lg-auto" type="submit">{{ _('Cancel session') }}</button>
            </form>
            {% elif cancel_mode == 'needs_approval' %}
            <form method="post" action="{{ url_for('student.cancel_appointment', appointment_id=appointment.id) }}">
              <button class="btn btn-outline-warning w-100 w-lg-auto" type="submit">{{ _('Request cancellation') }}</button>
              <div class="form-text text-start text-lg-end">{{ _('Within 24 hours, your coach must approve the request.') }}</div>
            </form>
            {% elif cancel_mode == 'pending' %}
            <span class="badge bg-warning text-dark">{{ _('Awaiting coach approval') }}</span>
            {% else %}
            <span class="text-muted small">{{ _('Cancellations closed within 2 hours of start time.') }}</span>
            {% endif %}
          </div>
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
  {% else %}
  <div class="alert alert-info" role="alert">
    {{ _('You have no upcoming sessions booked. Check with your coach to schedule one.') }}
  </div>
  {% endif %}
</section>

<section>
  <h2 class="h5">{{ _('Recent practice summary') }}</h2>
  {% if latest_summary %}
  <p class="mb-1">{{ _('Last mock exam score:') }} <strong>{{ latest_summary.score }}%</strong></p>
  <p class="text-muted">{{ _('Attempted on {date}.').format(date=latest_summary.taken_at.strftime('%d %b %Y')) }}</p>
  {% else %}
  <div class="alert alert-secondary" role="alert">
    {{ _('Complete a mock exam in the learner app to see your progress here.') }}
  </div>
  {% endif %}
</section>
{% endblock %}
