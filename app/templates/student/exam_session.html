{% extends 'base.html' %}
{% block title %}{{ _('Exam Session') }}{% endblock %}
{% block content %}
{% set total_questions = questions|length %}
<div class="exam-session-layout">
  <div class="exam-session-header mb-4 d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
    <div>
      <h1 class="h4 mb-1">{{ _('Exam session') }} · {{ exam_session.paper.title if exam_session.paper else _('Unknown paper') }}</h1>
      <div class="text-muted small">
        {{ _('Started at') }} {{ exam_session.started_at.strftime('%Y-%m-%d %H:%M') }} · {{ _('State') }} {{ exam_session.state }}
      </div>
    </div>
    <div class="d-flex align-items-center gap-3">
      <span class="badge {% if exam_session.status == 'submitted' %}bg-success{% elif exam_session.status == 'abandoned' %}bg-secondary{% else %}bg-primary{% endif %}">
        {{ exam_session.status|capitalize }}
      </span>
      {% if exam_session.status == 'ongoing' %}
      <div class="timer-display" data-remaining="{{ remaining_seconds }}">
        <span class="label">{{ _('Time left') }}</span>
        <strong class="time">--:--</strong>
      </div>
      {% endif %}
    </div>
  </div>

  {% if submission %}
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <p class="text-muted mb-2">{{ _('Final score') }}</p>
          <div class="display-5 fw-semibold text-primary">{{ submission.score }} / {{ submission.total }}</div>
          <p class="mb-3">{{ _('Pass mark') }}: {{ submission.pass_mark }}</p>
          {% if submission.passed %}
          <span class="badge bg-success px-3 py-2">{{ _('Passed') }}</span>
          {% else %}
          <span class="badge bg-danger px-3 py-2">{{ _('Not passed') }}</span>
          {% endif %}
        </div>
      </div>
      <a class="btn btn-outline-primary w-100 mt-3" href="{{ url_for('student.exams') }}">{{ _('Back to exam centre') }}</a>
    </div>
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h2 class="h5 mb-0">{{ _('Question review') }}</h2>
        </div>
        <div class="card-body">
          <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
            <div class="btn-group" role="group" aria-label="{{ _('Review filter') }}">
              <a
                class="btn btn-outline-primary btn-sm{% if not incorrect_only %} active{% endif %}"
                href="{{ url_for('student.exam_session', session_id=exam_session.id, page=1) }}"
              >
                {{ _('All questions') }}
              </a>
              <a
                class="btn btn-outline-primary btn-sm{% if incorrect_only %} active{% endif %}"
                href="{{ url_for('student.exam_session', session_id=exam_session.id, page=1, review='incorrect') }}"
              >
                {{ _('Incorrect only') }} ({{ incorrect_count }})
              </a>
            </div>
            <div class="text-muted small ms-md-auto">
              {{ _('Page') }} {{ review_page }} / {{ review_total_pages }}
            </div>
          </div>
          <div class="list-group list-group-flush">
            {% for item in review_questions %}
            {% set q = item.question %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h3 class="h6">{{ item.position }}. {{ q.prompt }}</h3>
                  <p class="text-muted small mb-2">{{ _('Topic') }}: {{ q.topic }}</p>
                  <ul class="list-unstyled mb-2 options-list">
                    <li {% if q.correct_option == 'A' %}class="correct"{% endif %}><strong>A.</strong> {{ q.option_a }}</li>
                    <li {% if q.correct_option == 'B' %}class="correct"{% endif %}><strong>B.</strong> {{ q.option_b }}</li>
                    <li {% if q.correct_option == 'C' %}class="correct"{% endif %}><strong>C.</strong> {{ q.option_c }}</li>
                    <li {% if q.correct_option == 'D' %}class="correct"{% endif %}><strong>D.</strong> {{ q.option_d }}</li>
                  </ul>
                  <div class="alert {% if item.answer and item.answer.is_correct %}alert-success{% else %}alert-danger{% endif %} py-2">
                    {% if item.answer %}
                    {{ _('Your answer') }}: {{ item.answer.selected_option or _('No response') }}
                    {% else %}
                    {{ _('No response recorded') }}
                    {% endif %}
                  </div>
                  {% if q.explanation %}
                  <div class="text-muted small">{{ _('Explanation') }}: {{ q.explanation }}</div>
                  {% endif %}
                </div>
                <div class="d-flex flex-column align-items-end gap-2">
                  <form method="post" action="{{ url_for('student.toggle_star', question_id=q.id) }}">
                    <input type="hidden" name="next" value="{{ request.full_path or request.path }}">
                    {% if q.id in starred_ids %}
                    <input type="hidden" name="action" value="unstar">
                    <button type="submit" class="btn btn-sm btn-warning">⭐ {{ _('Remove from notebook') }}</button>
                    {% else %}
                    <input type="hidden" name="action" value="star">
                    <button type="submit" class="btn btn-sm btn-outline-warning">☆ {{ _('Add to notebook') }}</button>
                    {% endif %}
                  </form>
                  {% if item.answer and item.answer.is_correct %}
                  <span class="badge bg-success">{{ _('Correct') }}</span>
                  {% else %}
                  <span class="badge bg-warning text-dark">{{ _('Review') }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
            {% else %}
            <div class="list-group-item text-center text-muted py-4">
              {{ _('No questions match the current filter.') }}
            </div>
            {% endfor %}
          </div>
          {% if review_total_pages > 1 %}
          {% set review_param = 'incorrect' if incorrect_only else None %}
          <nav class="mt-3" aria-label="{{ _('Review pagination') }}">
            <ul class="pagination pagination-sm mb-0 justify-content-end">
              {% set prev_page = review_page - 1 %}
              <li class="page-item{% if review_page == 1 %} disabled{% endif %}">
                <a
                  class="page-link"
                  href="{{ url_for('student.exam_session', session_id=exam_session.id, page=prev_page, review=review_param) }}"
                  aria-label="{{ _('Previous page') }}"
                >&laquo;</a>
              </li>
              {% for page_number in range(1, review_total_pages + 1) %}
              <li class="page-item{% if page_number == review_page %} active{% endif %}">
                <a
                  class="page-link"
                  href="{{ url_for('student.exam_session', session_id=exam_session.id, page=page_number, review=review_param) }}"
                >{{ page_number }}</a>
              </li>
              {% endfor %}
              {% set next_page = review_page + 1 %}
              <li class="page-item{% if review_page == review_total_pages %} disabled{% endif %}">
                <a
                  class="page-link"
                  href="{{ url_for('student.exam_session', session_id=exam_session.id, page=next_page, review=review_param) }}"
                  aria-label="{{ _('Next page') }}"
                >&raquo;</a>
              </li>
            </ul>
          </nav>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% else %}
  {% set current = questions[current_index] %}
  {% set option_map = {'A': current.question.option_a, 'B': current.question.option_b, 'C': current.question.option_c, 'D': current.question.option_d} %}
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <span class="badge bg-light text-dark me-2">{{ _('Question') }} {{ current_index + 1 }} / {{ total_questions }}</span>
              <span class="text-muted small">{{ _('Topic') }}: {{ current.question.topic }}</span>
            </div>
            <div class="d-flex align-items-start gap-2">
              <form method="post" action="{{ url_for('student.toggle_star', question_id=current.question.id) }}">
                <input type="hidden" name="next" value="{{ request.full_path or request.path }}">
                {% if current.question.id in starred_ids %}
                <input type="hidden" name="action" value="unstar">
                <button type="submit" class="btn btn-sm btn-warning">⭐ {{ _('Remove from notebook') }}</button>
                {% else %}
                <input type="hidden" name="action" value="star">
                <button type="submit" class="btn btn-sm btn-outline-warning">☆ {{ _('Add to notebook') }}</button>
                {% endif %}
              </form>
              <form method="post" onsubmit="return confirm('{{ _('Submit the entire exam?') }}')">
                <input type="hidden" name="action" value="submit_exam">
                <button type="submit" class="btn btn-danger btn-sm">{{ _('Submit exam') }}</button>
              </form>
            </div>
          </div>
          <h2 class="h5 mb-4">{{ current.question.prompt }}</h2>
          <form method="post" class="question-form">
            <input type="hidden" name="action" value="save_answer">
            <input type="hidden" name="question_id" value="{{ current.question.id }}">
            <div class="list-group mb-4">
              {% for option in ['A', 'B', 'C', 'D'] %}
              {% set option_text = option_map[option] %}
              <label class="list-group-item list-group-item-action d-flex align-items-center">
                <input class="form-check-input me-3" type="radio" name="selected_option" value="{{ option }}" {% if current.answer and current.answer.selected_option == option %}checked{% endif %}>
                <div>
                  <strong>{{ option }}.</strong> {{ option_text }}
                </div>
              </label>
              {% endfor %}
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="btn-group" role="group">
                <button class="btn btn-outline-secondary" type="submit" name="navigate_to" value="{{ current_index + 1 }}">{{ _('Save & stay') }}</button>
                {% if current_index + 1 < total_questions %}
                <button class="btn btn-primary" type="submit" name="navigate_to" value="{{ current_index + 2 }}">{{ _('Save & next') }}</button>
                {% else %}
                <button class="btn btn-primary" type="submit" name="navigate_to" value="{{ total_questions }}">{{ _('Save answer') }}</button>
                {% endif %}
              </div>
              <a class="btn btn-link" href="{{ url_for('student.exams') }}">{{ _('Exit to exam centre') }}</a>
            </div>
          </form>
        </div>
      </div>
      {% if current.question.explanation %}
      <div class="alert alert-info mt-3 small">
        <strong>{{ _('Remember') }}:</strong> {{ current.question.explanation }}
      </div>
      {% endif %}
    </div>
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h2 class="h6 mb-0">{{ _('Question navigator') }}</h2>
        </div>
        <div class="card-body">
          <div class="row g-2">
            {% for item in questions %}
            <div class="col-3">
              {% set navigator_class = 'btn-primary' if loop.index0 == current_index else 'btn-success' if item.question.id in answered_ids else 'btn-outline-secondary' %}
              <a class="btn btn-sm w-100 {{ navigator_class }}" href="{{ url_for('student.exam_session', session_id=exam_session.id, q=loop.index) }}">
                {{ loop.index }}
              </a>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% if exam_session.status == 'ongoing' %}
<script>
  (function () {
    const timer = document.querySelector('.timer-display');
    if (!timer) return;
    let remaining = parseInt(timer.getAttribute('data-remaining') || '0', 10);
    const timeEl = timer.querySelector('.time');
    function render() {
      const minutes = Math.floor(remaining / 60);
      const seconds = remaining % 60;
      timeEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      if (remaining <= 0) {
        timeEl.classList.add('text-danger');
        clearInterval(interval);
      }
    }
    render();
    const interval = setInterval(function () {
      remaining -= 1;
      if (remaining < 0) {
        remaining = 0;
        clearInterval(interval);
      }
      render();
    }, 1000);
  })();
</script>
{% endif %}
{% endblock %}
